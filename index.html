<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>氣象資料首頁</title>
  <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/@popperjs/core/dist/umd/popper.min.js"></script>
  <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
  <style>
    div {
      margin: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <div>
        <select id="citySelected" name="citySelected" class="custom-select"></select>
      </div>
      <div style="color: red;" id="citySelectedErr"></div>
    </div>
    <h3>近三天天氣</h3>
    <div class="card-deck" id="threeDaysWeather">
      <div class="card bg-primary">
        <div class="card-body text-center">
          <p class="card-text">---</p>
        </div>
      </div>
      <div class="card bg-primary">
        <div class="card-body text-center">
          <p class="card-text">---</p>
        </div>
      </div>
      <div class="card bg-primary">
        <div class="card-body text-center">
          <p class="card-text">---</p>
        </div>
      </div>
    </div>
    <h3>近一周天氣</h3>
    <div class="card-group" id="oneWeekWeather">
      <div class="card bg-success">
        <div class="card-body text-center">
          <p class="card-text">---</p>
        </div>
      </div>
      <div class="card bg-success">
        <div class="card-body text-center">
          <p class="card-text">---</p>
        </div>
      </div>
      <div class="card bg-success">
        <div class="card-body text-center">
          <p class="card-text">---</p>
        </div>
      </div>
      <div class="card bg-success">
        <div class="card-body text-center">
          <p class="card-text">---</p>
        </div>
      </div>
      <div class="card bg-success">
        <div class="card-body text-center">
          <p class="card-text">---</p>
        </div>
      </div>
      <div class="card bg-success">
        <div class="card-body text-center">
          <p class="card-text">---</p>
        </div>
      </div>
      <div class="card bg-success">
        <div class="card-body text-center">
          <p class="card-text">---</p>
        </div>
      </div>
    </div>
    <h3>累積雨量</h3>
    <div class="row" id="rainData">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>觀測站</th>
            <th>觀測時間</th>
            <th>近3小時累積</th>
            <th>近24小時累積</th>
          </tr>
        </thead>
        <tbody id="rainContent">
        </tbody>
      </table>
    </div>
  </div>
</body>

<script>
  $(document).ready(function () {
    // let date = Date.parse("2020-08-28 09:26:44")/1000;
    // let date2 = Date.parse("2020-08-28 09:36:44")/1000;
    // let date3 = Date.parse(new Date())/1000;
    // alert((date3-date2) > 60*60);
    // alert((date2-date)/60);
    let data2Update = {
      "getWeatherCatchTime": 1,
      "getRainCatchTime": 1
    }
    $.ajax({
      type: "POST",
      url: "myApi.php",
      data: data2Update
    }).then(function(dataFromServer) {
      let data = JSON.parse(dataFromServer);
      // console.log(data);
      let getRainData = 0;
      let getWeatherData = 0;
      let dateWeather = Date.parse(data[0].catchTime)/1000;
      let dateRain = Date.parse(data[1].catchTime)/1000;
      let now = Date.parse(new Date())/1000;
      if((now-dateWeather) > 60*60*24) {
        getWeatherData = 1;
      }
      if((now-dateRain) > 60*10) {
        getRainData = 1;
      }

      let data2Server = {
        "getWeatherData": getWeatherData,
        "getRainData": getRainData
      }
      // console.log(data2Server);
      $.ajax({
        type: "POST",
        url: "myApi.php",
        data: data2Server
      }).then(function(dataFromServer) {

      }).catch(function(e) {
        console.log(e.message);
      })
    }).catch(function(e) {
      console.log(e.message);
    });

    $.ajax({
      type: "GET",
      url: "myApi.php"
    }).then(function(dataFromServer) {
      let data = JSON.parse(dataFromServer);
      // console.log(data);
      $("#citySelected").append("<option value='-1' selected>--</option>");
      for(let oneData of data) {
        let appendItem = $("<option></option>").prop("value", oneData["cityId"]).append(oneData["cityName"]);
        $("#citySelected").append(appendItem);
      }
    }).catch(function(e) {
      console.log(e);
    })

    $("#citySelected").on("change", function() {
      let cityId = $("#citySelected").prop('value');
      let data2GetWeather = {"cityId": cityId};
      if(cityId == "-1") {
        $("#citySelectedErr").html("請選擇城市");
        $("#threeDaysWeather").empty();
        $("#oneWeekWeather").empty();
      }
      else{
        $.ajax({
          type: "POST",
          url: `myApi.php`,
          data: data2GetWeather
        }).then(function(dataFromServer){
          let data = JSON.parse(dataFromServer);
          // console.log(data);
          $("#threeDaysWeather").empty();
          $("#citySelectedErr").html("");
          for(let i = 0; i < 6; i += 2) {
            let date = new Date(data[i].startTime);
            let card  = $("<div></div>").prop("class", "card bg-primary");
            let card_body = $("<div></div>").prop("class", "card-body text-center");
            let oneDay = $("<p></p>")
            .append(
              (date.getMonth()+1) + "/" + date.getDate() + "<br>" + 
              data[i].wx + "<br>" +
              "溫度: " + data[i].minT + "度 - " + data[i].maxT + "度<br>" +
              "體感溫度: " + data[i].minAT + "度 - " + data[i].maxAT + "度<br>" +
              "降雨機率: " + data[i].pop12h + " %<br>" +
              "風速: " + data[i].ws1 + " 級風<br>" +
              "風向: " + data[i].wd
            )
            .prop("class", "card-text")
            .css("color", "white");
            $("#threeDaysWeather").append(card.append(card_body.append(oneDay)));
          }
          $("#oneWeekWeather").empty();
          for(let i = 0; i < 14; i += 2) {
            let date = new Date(data[i].startTime);
            let card  = $("<div></div>").prop("class", "card bg-success");
            let card_body = $("<div></div>").prop("class", "card-body text-center");
            let oneDay = $("<p></p>")
            .append(
              (date.getMonth()+1) + "/" + date.getDate() + "<br>" +
              data[i].wx + "<br>" +
              data[i].minT + "度 - " + data[i].maxT + "度<br>" +
              "降雨機率: " + data[i].pop12h + " %<br>" +
              "風速: " + data[i].ws1 + " 級風<br>" +
              "風向: " + data[i].wd
            )
            .prop("class", "card-text")
            .css({"color": "white", "font-size": "10px"});
            $("#oneWeekWeather").append(card.append(card_body.append(oneDay)));
          }
        }).catch(function(e){
          console.log(e.message);
        });

        let data2GetRain = {
          "getRainDataFromServer": 1,
          "cityId": cityId
        }
        // console.log(data2GetRain);
        $.ajax({
          type: "POST",
          url: "myApi.php",
          data: data2GetRain
        }).then(function(dataFromServer) {
          let data = JSON.parse(dataFromServer);
          console.log(data);
          $("#rainContent").empty();
          for(oneData of data) {
            let oneTr = $("<tr></tr>");
            oneTr.append("<td>" + oneData.locationName + "</td>");
            oneTr.append("<td>" + oneData.obsTime + "</td>");
            if(oneData.hour_3 == "-998.00") {
              oneTr.append("<td style='color: red;'>故障</td>");
            }
            else {
              oneTr.append("<td>" + oneData.hour_3 + "</td>");
            }
            oneTr.append("<td>" + oneData.hour_24 + "</td>");
            $("#rainContent").append(oneTr);
          }
        }).catch(function(e) {
          console.log(e.message);
        });
      }
    });
  });
</script>

</html>