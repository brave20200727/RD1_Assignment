<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>氣象局網站資料</title>
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
  <style>
    div {
      margin: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-6">
        <select id="citySelected" name="citySelected"></select>
      </div>
      <!-- <div class="col-4">
        <select id="rangeSelected" name="rangeSelected"></select>
      </div> -->
      <!-- <div class="col-6">
        <button id="okButton">確定</button>
      </div>     -->
    </div>

    <div class="row">
      <div id="firstWeather" class="col-3"></div>
      <div id="secondWeather" class="col-3"></div>
      <div id="thirdWeather" class="col-3"></div>
    </div>  
  </div>
</body>

<script>

  // 近兩日的資料抓取
  function get2DaysWeather(data) {
    let locationData = data.records.locations[0].location; // 縣市中各區的資料
    for(let item of locationData) { // 將各個區都跑過一輪 並且將資料給抓出來
      $("#resultDiv").append("<h3>" + item.locationName + "</h3>");
      $("#resultDiv").append("<h5>" + item.weatherElement[6].description + "</h5>");
      for(let timeItem of item.weatherElement[6].time) {
        $("#resultDiv").append(timeItem.startTime + "&nbsp;&nbsp;&nbsp;&nbsp;");
        $("#resultDiv").append(timeItem.endTime + "<br>");
        $("#resultDiv").append(timeItem.elementValue[0].value + "<br>");
      }
      $("#resultDiv").append("<hr>");
    }
  }

  // 近一週的資料抓取
  function get1WeekWeather(data) {
    let locationData = data.records.locations[0].location; // 縣市中各區的資料
    for(let item of locationData) { // 將各個區都跑過一輪 並且將資料給抓出來
      $("#resultDiv").append("<h3>" + item.locationName + "</h3>");
      $("#resultDiv").append("<h5>" + item.weatherElement[10].description + "</h5>");
      for(let timeItem of item.weatherElement[10].time) {
        $("#resultDiv").append(timeItem.startTime + "&nbsp;&nbsp;&nbsp;&nbsp;");
        $("#resultDiv").append(timeItem.endTime + "<br>");
        $("#resultDiv").append(timeItem.elementValue[0].value + "<br>");
      }
      $("#resultDiv").append("<hr>");
    }
  }
  
  // 存有所有城市的Array
  // let cityArray = [
  //   {"cityName": "基隆市", "value": 49},
  //   {"cityName": "臺北市", "value": 61},
  //   {"cityName": "新北市", "value": 69},
  //   {"cityName": "桃園市", "value": 5},
  //   {"cityName": "新竹縣", "value": 9},
  //   {"cityName": "新竹市", "value": 53},
  //   {"cityName": "苗栗縣", "value": 13},
  //   {"cityName": "臺中市", "value": 73},
  //   {"cityName": "彰化縣", "value": 17},
  //   {"cityName": "南投縣", "value": 21},
  //   {"cityName": "雲林縣", "value": 25},
  //   {"cityName": "嘉義縣", "value": 29},
  //   {"cityName": "嘉義市", "value": 57},
  //   {"cityName": "臺南市", "value": 77},
  //   {"cityName": "高雄市", "value": 65},
  //   {"cityName": "屏東縣", "value": 33},
  //   {"cityName": "宜蘭縣", "value": 1},
  //   {"cityName": "臺東縣", "value": 37},
  //   {"cityName": "花蓮縣", "value": 41},
  //   {"cityName": "澎湖縣", "value": 45},
  //   {"cityName": "連江縣", "value": 81},
  //   {"cityName": "金門縣", "value": 85}
  // ]
  $(document).ready(function () {
    let key = "CWB-237F0446-FCE5-4CD0-A343-4C4B52E42D65";
    $("#citySelected").append($("<option></option>").prop("value", -1).append("--"));
    $.ajax({
      type: "get",
      url: "myApi.php"
    }).then(function(dataForServer) {
      let answer = JSON.parse(dataForServer);
      for(let city of answer) {
        let oneCity = $("<option></option>").prop("value", city.cityId).append(city.cityName);
        $("#citySelected").append(oneCity);
      };
    }).catch(function(e) {
      console.log(e.message);
    })
    
    let userCityName = ""; // 用來儲存使用者所選的城市名
    $("#citySelected").on("change", function(){
      let cityId = $("#citySelected").prop("value");
      console.log(cityId);
      $.ajax({
        type: "get",
        url: `myApi.php?cityId=${cityId}`
      }).then(function(dataForServer) {
        let answer = JSON.parse(dataForServer);
        console.log(answer);
        userCityName = answer.cityName;
        console.log(userCityName);
      }).catch(function(e) {
        console.log(e.message);
      })
      // console.log(userCity);

      $("#firstWeather").empty();
      $("#secondWeather").empty();
      $("#thirdWeather").empty();
      $.ajax({
        type: "get",
        url: "https://opendata.cwb.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=CWB-237F0446-FCE5-4CD0-A343-4C4B52E42D65&sort=time"        
      }).then(function(data) {
        // let answer = JSON.parse(data);
        // console.log(answer);
        let cityWeatherInfo = data.records.location; // 抓出個縣市36小時內天氣資料的array
        let userCity;
        for(city of cityWeatherInfo) {
          if(city.locationName == userCityName) {
            userCity = city;
          }
        }
        console.log(userCity);
        $("#firstWeather").append("今晨天氣<br>");
        $("#firstWeather").append("天氣描述： " + userCity.weatherElement[0].time[0].parameter.parameterName + "<br>");
        $("#firstWeather").append("降雨機率： " + userCity.weatherElement[1].time[0].parameter.parameterName + "%<br>");
        $("#firstWeather").append("最高溫度： " + userCity.weatherElement[2].time[0].parameter.parameterName + "攝氏度<br>");
        $("#firstWeather").append("最低溫度： " + userCity.weatherElement[4].time[0].parameter.parameterName + "攝氏度<br>");
        $("#firstWeather").append("舒適度： " + userCity.weatherElement[3].time[0].parameter.parameterName);
        $("#firstWeather").css("background-color", "lightblue");
        $("#secondWeather").append("今晚天氣<br>");
        $("#secondWeather").append("天氣描述： " + userCity.weatherElement[0].time[1].parameter.parameterName + "<br>");
        $("#secondWeather").append("降雨機率： " + userCity.weatherElement[1].time[1].parameter.parameterName + "%<br>");
        $("#secondWeather").append("最高溫度： " + userCity.weatherElement[2].time[1].parameter.parameterName + "攝氏度<br>");
        $("#secondWeather").append("最低溫度： " + userCity.weatherElement[4].time[1].parameter.parameterName + "攝氏度<br>");
        $("#secondWeather").append("舒適度： " + userCity.weatherElement[3].time[1].parameter.parameterName);
        $("#secondWeather").css("background-color", "lightblue");
        $("#thirdWeather").append("明晨天氣<br>");
        $("#thirdWeather").append("天氣描述： " + userCity.weatherElement[0].time[2].parameter.parameterName + "<br>");
        $("#thirdWeather").append("降雨機率： " + userCity.weatherElement[1].time[2].parameter.parameterName + "%<br>");
        $("#thirdWeather").append("最高溫度： " + userCity.weatherElement[2].time[2].parameter.parameterName + "攝氏度<br>");
        $("#thirdWeather").append("最低溫度： " + userCity.weatherElement[4].time[2].parameter.parameterName + "攝氏度<br>");
        $("#thirdWeather").append("舒適度： " + userCity.weatherElement[3].time[2].parameter.parameterName);
        $("#thirdWeather").css("background-color", "lightblue");
      }).catch(function(e) {
        console.log(e.message);
      })
    });

    // 按下確定鍵就會進行資料的抓取以及顯示在網頁上面
    // $("#okButton").on("click", function () {
    //   $("#resultDiv").empty();
    //   let dataPool = Number($("#citySelected").prop("value")) + Number($("#rangeSelected").prop("value"));
    //   if (dataPool < 10) {
    //     dataPool = "00" + dataPool;
    //   }
    //   else if (dataPool < 100) {
    //     dataPool = "0" + dataPool;
    //   }
    //   // $("#resultDiv").text(dataPos);
    //   $.ajax({
    //     type: "get",
    //     url: `https://opendata.cwb.gov.tw/api/v1/rest/datastore/F-D0047-${dataPool}?Authorization=${key}`
    //   }).then(function (data) {
    //     console.log(data.records.locations[0].location);
    //     let rangeValue = $("#rangeSelected").prop("value");
    //     if(rangeValue == "0") {
    //       get2DaysWeather(data);
    //     }
    //     else {
    //       get1WeekWeather(data);
    //     }
    //   }).catch(function (e) {
    //     console.log(e.message);
    //   });
    // });
  });
</script>

</html>