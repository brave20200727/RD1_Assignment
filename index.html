<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>氣象局網站資料</title>
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
  <style>
    div {
      margin: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-6">
        <select id="citySelected" name="citySelected"></select>
      </div>
      <!-- <div class="col-4">
        <select id="rangeSelected" name="rangeSelected"></select>
      </div> -->
      <!-- <div class="col-6">
        <button id="okButton">確定</button>
      </div>     -->
    </div>

    <div class="row">
      <div id="firstWeather" class="col-3"></div>
      <div id="secondWeather" class="col-3"></div>
      <div id="thirdWeather" class="col-3"></div>
    </div>
  </div>
</body>

<script>

  // 近一週的資料抓取
  function get1WeekWeather(data) {
    let locationData = data.records.locations[0].location; // 縣市中各區的資料
    for(let item of locationData) { // 將各個區都跑過一輪 並且將資料給抓出來
      $("#resultDiv").append("<h3>" + item.locationName + "</h3>");
      $("#resultDiv").append("<h5>" + item.weatherElement[10].description + "</h5>");
      for(let timeItem of item.weatherElement[10].time) {
        $("#resultDiv").append(timeItem.startTime + "&nbsp;&nbsp;&nbsp;&nbsp;");
        $("#resultDiv").append(timeItem.endTime + "<br>");
        $("#resultDiv").append(timeItem.elementValue[0].value + "<br>");
      }
      $("#resultDiv").append("<hr>");
    }
  }

  $(document).ready(function () {
    let key = "CWB-237F0446-FCE5-4CD0-A343-4C4B52E42D65";
    $("#citySelected").append($("<option></option>").prop("value", -1).append("--"));
    $.ajax({
      type: "get",
      url: "myApi.php"
    }).then(function(dataForServer) {
      let answer = JSON.parse(dataForServer);
      for(let city of answer) {
        let oneCity = $("<option></option>").prop("value", city.cityId).append(city.cityName);
        $("#citySelected").append(oneCity);
      };
    }).catch(function(e) {
      console.log(e.message);
    })

    let userCityName = ""; // 用來儲存使用者所選的城市名
    $("#citySelected").on("change", function(){
      let cityId = $("#citySelected").prop("value");
      console.log(cityId);
      $.ajax({
        type: "get",
        url: `myApi.php?cityId=${cityId}`
      }).then(function(dataForServer) {
        let answer = JSON.parse(dataForServer);
        console.log(answer);
        userCityName = answer.cityName;
        console.log(userCityName);
      }).catch(function(e) {
        console.log(e.message);
      })
      // console.log(userCity);

      $("#firstWeather").empty();
      $("#secondWeather").empty();
      $("#thirdWeather").empty();
      $.ajax({
        type: "get",
        url: "myApi.php?getWeather=1"
      }).then(function(data) {
        // console.log(data);
        let answer = JSON.parse(data);
        console.log(answer);
        let cityWeatherInfo = answer.records.locations[0].location; // 抓出個縣市36小時內天氣資料的array
        // console.log(cityWeatherInfo);
        let userCity;
        for(let city of cityWeatherInfo) {
          if(city.locationName == userCityName) {
            userCity = city;
          }
        }
        console.log(userCity);
      }).catch(function(e) {
        console.log(e.message);
      })
    });

    // 按下確定鍵就會進行資料的抓取以及顯示在網頁上面
    // $("#okButton").on("click", function () {
    //   $("#resultDiv").empty();
    //   let dataPool = Number($("#citySelected").prop("value")) + Number($("#rangeSelected").prop("value"));
    //   if (dataPool < 10) {
    //     dataPool = "00" + dataPool;
    //   }
    //   else if (dataPool < 100) {
    //     dataPool = "0" + dataPool;
    //   }
    //   // $("#resultDiv").text(dataPos);
    //   $.ajax({
    //     type: "get",
    //     url: `https://opendata.cwb.gov.tw/api/v1/rest/datastore/F-D0047-${dataPool}?Authorization=${key}`
    //   }).then(function (data) {
    //     console.log(data.records.locations[0].location);
    //     let rangeValue = $("#rangeSelected").prop("value");
    //     get1WeekWeather(data);
    //   }).catch(function (e) {
    //     console.log(e.message);
    //   });
    // });
  });
</script>

</html>