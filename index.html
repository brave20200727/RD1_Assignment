<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>氣象局網站資料</title>
  <script src="/node_modules/jquery/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">
</head>

<body>
  <div class="row">
    <div>
      <select id="citySelected" name="citySelected" style="width: 10em; margin-left: 2em; margin-top: 1em; margin-bottom: 1em;">
      </select>
    </div>
    <div>
      <select id="rangeSelected" name="rangeSelected" style="width: 10em; margin-left: 2em; margin-top: 1em; margin-bottom: 1em;">
        <option value="0">未來兩天</option>
        <option value="2">未來一週</option>
      </select>
    </div>
    <div>
      <button id="okButton" style="margin-left: 2em; margin-top: 1em; margin-bottom: 1em;">確定</button>
    </div>    
  </div>

  <div id="resultDiv"></div>
</body>

<script>

  function get2DaysWeather(data) {
    let locationData = data.records.locations[0].location; // 縣市中各區的資料
    for(let item of locationData) { // 將各個區都跑過一輪 並且將資料給抓出來
      $("#resultDiv").append("<h3>" + item.locationName + "</h3>");
      $("#resultDiv").append("<h5>" + item.weatherElement[6].description + "</h5>");
      for(let timeItem of item.weatherElement[6].time) {
        $("#resultDiv").append(timeItem.startTime + "&nbsp;&nbsp;&nbsp;&nbsp;");
        $("#resultDiv").append(timeItem.endTime + "<br>");
        $("#resultDiv").append(timeItem.elementValue[0].value + "<br>");
      }
      $("#resultDiv").append("<hr>");
    }
  }

  function get1WeekWeather(data) {
    let locationData = data.records.locations[0].location; // 縣市中各區的資料
    for(let item of locationData) { // 將各個區都跑過一輪 並且將資料給抓出來
      $("#resultDiv").append("<h3>" + item.locationName + "</h3>");
      $("#resultDiv").append("<h5>" + item.weatherElement[10].description + "</h5>");
      for(let timeItem of item.weatherElement[10].time) {
        $("#resultDiv").append(timeItem.startTime + "&nbsp;&nbsp;&nbsp;&nbsp;");
        $("#resultDiv").append(timeItem.endTime + "<br>");
        $("#resultDiv").append(timeItem.elementValue[0].value + "<br>");
      }
      $("#resultDiv").append("<hr>");
    }
  }

  function showTotalWeather(allCity) {
    let userChoose;
    // for(city of allCity) {
    //   if(city.locationName == $(#""))
    // }
  }

  // 存有所有城市的Array
  let cityArray = [
    {"cityName": "基隆縣", "value": 49},
    {"cityName": "臺北市", "value": 61},
    {"cityName": "新北市", "value": 69},
    {"cityName": "桃園市", "value": 5},
    {"cityName": "新竹縣", "value": 9},
    {"cityName": "新竹市", "value": 53},
    {"cityName": "苗栗縣", "value": 13},
    {"cityName": "臺中市", "value": 73},
    {"cityName": "彰化縣", "value": 17},
    {"cityName": "南投縣", "value": 21},
    {"cityName": "雲林縣", "value": 25},
    {"cityName": "嘉義縣", "value": 29},
    {"cityName": "嘉義市", "value": 57},
    {"cityName": "臺南市", "value": 77},
    {"cityName": "高雄市", "value": 65},
    {"cityName": "屏東縣", "value": 33},
    {"cityName": "宜蘭縣", "value": 1},
    {"cityName": "臺東縣", "value": 37},
    {"cityName": "花蓮縣", "value": 41},
    {"cityName": "澎湖縣", "value": 45},
    {"cityName": "連江縣", "value": 81},
    {"cityName": "金門縣", "value": 85}
  ]

  $(document).ready(function () {
    let key = "CWB-237F0446-FCE5-4CD0-A343-4C4B52E42D65";
    for(city of cityArray) {
      let oneCity = $("<option></option>").prop("value", city.value).append(city.cityName);
      $("#citySelected").append(oneCity);
    };

    $("#okButton").on("click", function () {
      $("#resultDiv").empty();
      let dataPool = Number($("#citySelected").prop("value")) + Number($("#rangeSelected").prop("value"));
      if (dataPool < 10) {
        dataPool = "00" + dataPool;
      }
      else if (dataPool < 100) {
        dataPool = "0" + dataPool;
      }
      // $("#resultDiv").text(dataPos);
      $.ajax({
        type: "get",
        url: `https://opendata.cwb.gov.tw/api/v1/rest/datastore/F-D0047-${dataPool}?Authorization=${key}`
      }).then(function (data) {
        console.log(data.records.locations[0].location);
        let rangeValue = $("#rangeSelected").prop("value");
        if(rangeValue == "0") {
          get2DaysWeather(data);
        }
        else {
          get1WeekWeather(data);
        }
      }).catch(function (e) {
        console.log(e.message);
      });
    });

    let cityWeatherInfo;
    $("#citySelected").on("change", function(){
      // 找出與citySelected所選出的城市一樣的城市
      let cityItem;
      for(city of cityArray) {
        if(city.value == $("#citySelected").prop("value")){
          cityItem = city;
        }
      }
      $.ajax({
        type: "get",
        url: "https://opendata.cwb.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=CWB-237F0446-FCE5-4CD0-A343-4C4B52E42D65&sort=time"        
      }).then(function(data) {
        console.log(data);
        cityWeatherInfo = data.records.location; // 抓出個縣市36小時內天氣資料的array
      }).catch(function(e) {
        console.log(e.message);
      })
      
    });

  });
</script>

</html>